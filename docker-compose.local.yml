# Docker Compose for Local Development
# 0x.ship Discovery Platform
# Usage: docker compose -f docker-compose.local.yml up -d --build

version: '3.8'

services:
  # PostgreSQL Database (Local)
  postgres:
    image: postgres:16-alpine
    container_name: zer0_postgres_local
    restart: unless-stopped
    environment:
      POSTGRES_USER: zer0_user
      POSTGRES_PASSWORD: zer0_local_password_change_me
      POSTGRES_DB: zer0_discovery
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --lc-collate=C --lc-ctype=C"
    ports:
      - "5433:5432"  # Expose on 5433 to avoid conflict with existing postgres
    volumes:
      - postgres_local_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U zer0_user -d zer0_discovery"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - zer0_network

  # Redis Cache (Local)
  redis:
    image: redis:7-alpine
    container_name: zer0_redis_local
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    ports:
      - "6380:6379"  # Expose on 6380 to avoid conflict with existing redis on 6379
    volumes:
      - redis_local_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - zer0_network

  # Backend (Flask + Gunicorn)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      args:
        BUILD_ENV: local
    container_name: zer0_backend_local
    restart: unless-stopped
    dns:
      - 8.8.8.8
      - 1.1.1.1
    dns_opt:
      - ndots:0
      - timeout:2
      - attempts:3
    dns_search: []
    links:
      - redis:redis
      - postgres:postgres
    env_file:
      - ./backend/.env.local
    environment:
      - FLASK_ENV=development
      - DATABASE_URL=postgresql://zer0_user:zer0_local_password_change_me@postgres:5432/zer0_discovery
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - RATELIMIT_STORAGE_URL=redis://redis:6379/1
      - CORS_ORIGINS=http://localhost:8080,http://localhost:3000,http://127.0.0.1:8080
      # Disable background workers in dev (run separately if needed)
      - DISABLE_CACHE_WARMER=false
      - DISABLE_MV_WORKER=false
      - DISABLE_RECONCILIATION=false
      - DISABLE_CELERY=false
      - IN_DEV=true
    ports:
      - "5000:5000"  # Backend API
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./backend:/app  # Mount for hot reload
      - backend_logs_local:/app/logs
    networks:
      - zer0_network
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:5000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Celery Worker (Background Tasks - Scoring, Votes, etc.)
  celery_worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
      args:
        BUILD_ENV: local
    container_name: zer0_celery_worker_local
    restart: unless-stopped
    command: celery -A celery_app.celery worker --loglevel=info --concurrency=2
    dns:
      - 8.8.8.8
      - 1.1.1.1
    dns_opt:
      - ndots:0
      - timeout:2
      - attempts:3
    dns_search: []
    links:
      - redis:redis
      - postgres:postgres
    env_file:
      - ./backend/.env.local
    environment:
      - FLASK_ENV=development
      - DATABASE_URL=postgresql://zer0_user:zer0_local_password_change_me@postgres:5432/zer0_discovery
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - IN_DEV=true
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./backend:/app  # Mount for hot reload
      - backend_logs_local:/app/logs
    networks:
      - zer0_network

  # Celery Beat (Periodic Tasks Scheduler)
  celery_beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
      args:
        BUILD_ENV: local
    container_name: zer0_celery_beat_local
    restart: unless-stopped
    command: celery -A celery_app.celery beat --loglevel=info
    dns:
      - 8.8.8.8
      - 1.1.1.1
    dns_opt:
      - ndots:0
      - timeout:2
      - attempts:3
    dns_search: []
    links:
      - redis:redis
      - postgres:postgres
    env_file:
      - ./backend/.env.local
    environment:
      - FLASK_ENV=development
      - DATABASE_URL=postgresql://zer0_user:zer0_local_password_change_me@postgres:5432/zer0_discovery
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - IN_DEV=true
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./backend:/app  # Mount for hot reload
      - backend_logs_local:/app/logs
    networks:
      - zer0_network

  # Frontend (Vite Dev Server)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.local
      args:
        VITE_API_URL: http://localhost:5000
    container_name: zer0_frontend_local
    restart: unless-stopped
    environment:
      - VITE_API_URL=http://localhost:5000
    ports:
      - "8080:8080"  # Frontend dev server
    volumes:
      - ./frontend:/app  # Mount for hot reload
      - /app/node_modules  # Prevent overwriting node_modules
    networks:
      - zer0_network
    depends_on:
      - backend

volumes:
  postgres_local_data:
    name: zer0_postgres_local_data
  redis_local_data:
    name: zer0_redis_local_data
  backend_logs_local:
    name: zer0_backend_logs_local

networks:
  zer0_network:
    name: zer0_local_network
    driver: bridge
